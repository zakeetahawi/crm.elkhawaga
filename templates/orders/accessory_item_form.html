{% extends 'base.html' %}
{% load static %}
{% load i18n %}
{% load widget_tweaks %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'home' %}">{% trans "الرئيسية" %}</a></li>
            <li class="breadcrumb-item"><a href="{% url 'orders:order_list' %}">{% trans "الطلبات" %}</a></li>
            <li class="breadcrumb-item"><a href="{% url 'orders:order_detail' order.id %}">{% trans "تفاصيل الطلب" %} #{{ order.id }}</a></li>
            <li class="breadcrumb-item active" aria-current="page">{% trans "إدارة الاكسسوارات" %}</li>
        </ol>
    </nav>

    <div class="card">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0">{% trans "إدارة الاكسسوارات للطلب" %} #{{ order.id }}</h4>
        </div>
        <div class="card-body">
            <div class="row mb-4">
                <div class="col-md-6">
                    <p><strong>{% trans "رقم الطلب:" %}</strong> {{ order.order_number }}</p>
                    <p><strong>{% trans "العميل:" %}</strong> {{ order.customer.name }}</p>
                </div>
                <div class="col-md-6">
                    <p><strong>{% trans "تاريخ التسليم:" %}</strong> {{ order.delivery_date|date:"Y-m-d" }}</p>
                    <p><strong>{% trans "الحالة:" %}</strong> {{ order.get_status_display }}</p>
                </div>
            </div>

            <form method="post" novalidate>
                {% csrf_token %}
                
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">{% trans "عناصر الاكسسوارات" %}</h5>
                    </div>
                    <div class="card-body">
                        {{ formset.management_form }}
                        
                        <div class="table-responsive">
                            <table class="table table-bordered" id="accessory-items-table">
                                <thead class="table-dark">
                                    <tr>
                                        <th>{% trans "المنتج" %}</th>
                                        <th>{% trans "الكمية" %}</th>
                                        <th>{% trans "ملاحظات" %}</th>
                                        <th>{% trans "حذف" %}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for form in formset %}
                                        <tr class="formset-row">
                                            <td>
                                                {{ form.id }}
                                                {% render_field form.product class="form-select" %}
                                                {% if form.product.errors %}
                                                    <div class="invalid-feedback d-block">
                                                        {% for error in form.product.errors %}
                                                            {{ error }}
                                                        {% endfor %}
                                                    </div>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% render_field form.quantity class="form-control" %}
                                                {% if form.quantity.errors %}
                                                    <div class="invalid-feedback d-block">
                                                        {% for error in form.quantity.errors %}
                                                            {{ error }}
                                                        {% endfor %}
                                                    </div>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% render_field form.notes class="form-control" rows="2" %}
                                                {% if form.notes.errors %}
                                                    <div class="invalid-feedback d-block">
                                                        {% for error in form.notes.errors %}
                                                            {{ error }}
                                                        {% endfor %}
                                                    </div>
                                                {% endif %}
                                            </td>
                                            <td class="text-center">
                                                {% if form.instance.pk %}
                                                    {% render_field form.DELETE class="form-check-input delete-checkbox" %}
                                                {% endif %}
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        
                        <button type="button" id="add-accessory-item" class="btn btn-outline-primary mt-3">
                            <i class="fas fa-plus"></i> {% trans "إضافة عنصر" %}
                        </button>
                    </div>
                </div>
                
                <div class="d-flex justify-content-between">
                    <a href="{% url 'orders:order_detail' order.id %}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> {% trans "العودة" %}
                    </a>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> {% trans "حفظ التغييرات" %}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const addButton = document.getElementById('add-accessory-item');
        const totalFormsInput = document.getElementById('id_accessory_items-TOTAL_FORMS');
        const formsetContainer = document.querySelector('#accessory-items-table tbody');
        
        addButton.addEventListener('click', function() {
            const formCount = parseInt(totalFormsInput.value);
            const newRow = document.createElement('tr');
            newRow.className = 'formset-row';
            
            // Get the HTML of the last form
            const lastRow = formsetContainer.querySelector('.formset-row:last-child');
            let newRowHtml = lastRow.innerHTML;
            
            // Replace form indices
            newRowHtml = newRowHtml.replaceAll(`accessory_items-${formCount-1}-`, `accessory_items-${formCount}-`);
            newRowHtml = newRowHtml.replaceAll(`id_accessory_items-${formCount-1}-`, `id_accessory_items-${formCount}-`);
            newRowHtml = newRowHtml.replaceAll(`for="id_accessory_items-${formCount-1}-`, `for="id_accessory_items-${formCount}-`);
            
            // Clear values
            newRow.innerHTML = newRowHtml;
            
            // Clear input values in the new row
            newRow.querySelectorAll('input[type="text"], input[type="number"], textarea').forEach(input => {
                input.value = '';
            });
            
            // Reset select elements
            newRow.querySelectorAll('select').forEach(select => {
                select.selectedIndex = 0;
            });
            
            // Remove DELETE checkbox if present
            const deleteCheckbox = newRow.querySelector('.delete-checkbox');
            if (deleteCheckbox) {
                deleteCheckbox.remove();
            }
            
            // Add the new row to the table
            formsetContainer.appendChild(newRow);
            
            // Update the total forms count
            totalFormsInput.value = formCount + 1;
        });
    });
</script>
{% endblock %}
